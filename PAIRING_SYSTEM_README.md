# Mesophy Digital Signage - Device Pairing System

## Overview

The Mesophy Digital Signage platform now includes a comprehensive device pairing system that replaces hardcoded screen IDs with dynamic device discovery and pairing. This system allows Raspberry Pi devices to automatically identify themselves and pair with screens configured in the admin portal.

## System Architecture

### Components

1. **Device Identification** (`pi-device-id.sh`)
   - Generates unique, stable device IDs using Pi hardware identifiers
   - Stores device configuration persistently
   - Provides fallback identification methods

2. **Pairing API** (`/api/devices/lookup`)
   - Allows Pi devices to check pairing status
   - Returns screen configuration for paired devices
   - Handles unpaired devices gracefully

3. **Updated Pi Client** (`pi-signage.sh`)
   - Automatically checks pairing status on startup
   - Displays pairing instructions when unpaired
   - Caches configuration locally for offline operation

4. **Pairing Instructions Display** (`show-pairing-instructions.sh`)
   - Creates visual pairing instructions on screen
   - Shows device ID and portal information
   - Provides both visual and console output

## Installation

### Quick Installation

```bash
# Download the installation script
curl -O https://your-server.com/install-pairing-system.sh

# Make executable and run
chmod +x install-pairing-system.sh
sudo ./install-pairing-system.sh
```

### Manual Installation

1. Install dependencies:
```bash
sudo apt-get update
sudo apt-get install fbi vlc curl python3 python3-pip python3-pil python3-requests
```

2. Copy scripts to Pi:
```bash
sudo mkdir -p /opt/mesophy/bin
sudo cp pi-signage.sh /opt/mesophy/bin/
sudo cp pi-device-id.sh /opt/mesophy/bin/
sudo cp show-pairing-instructions.sh /opt/mesophy/bin/
sudo chmod +x /opt/mesophy/bin/*.sh
```

3. Create convenience links:
```bash
sudo ln -sf /opt/mesophy/bin/pi-signage.sh /usr/local/bin/mesophy-signage
sudo ln -sf /opt/mesophy/bin/pi-device-id.sh /usr/local/bin/mesophy-device-id
```

## Usage

### Device Pairing Process

1. **Get Device ID**:
   ```bash
   mesophy-device-id
   # or
   mesophy-signage device-id
   ```

2. **Open Admin Portal**:
   - Navigate to `https://mesophy.vercel.app`
   - Go to Dashboard → Screens → Add New Screen

3. **Configure Screen**:
   - Enter the device ID from step 1
   - Assign to a location and set screen properties
   - Save the configuration

4. **Start Signage**:
   ```bash
   mesophy-signage start
   ```

The Pi will automatically detect pairing and begin displaying content.

### Command Reference

#### Main Signage Commands

```bash
# Start signage (will wait for pairing if needed)
mesophy-signage start

# Stop signage
mesophy-signage stop

# Restart signage
mesophy-signage restart

# Show status and pairing info
mesophy-signage status

# Check pairing status
mesophy-signage pair

# Show device ID for pairing
mesophy-signage device-id

# Test API connectivity (requires pairing)
mesophy-signage test

# View logs
mesophy-signage logs

# Show help
mesophy-signage help
```

#### Device ID Commands

```bash
# Get current device ID
mesophy-device-id

# Generate new device ID
mesophy-device-id generate

# Show detailed device information
mesophy-device-id info
```

#### Service Management

```bash
# Start as systemd service
sudo systemctl start mesophy-signage

# Enable auto-start on boot
sudo systemctl enable mesophy-signage

# View service logs
journalctl -u mesophy-signage -f
```

## Configuration Files

### Device Configuration
- **Location**: `/opt/mesophy/config/device-id.conf`
- **Contents**: Device ID and hardware identifiers
- **Generated by**: `pi-device-id.sh`

### Signage Configuration
- **Location**: `/opt/mesophy/config/signage.conf`
- **Contents**: Screen ID, API URLs, device token
- **Generated by**: `pi-signage.sh` after successful pairing

### Example Device Configuration
```bash
# Mesophy Digital Signage - Device Configuration
# Generated on Sat Aug 10 12:00:00 UTC 2024
DEVICE_ID="pi-1234567890abcdef"
```

### Example Signage Configuration
```bash
# Mesophy Digital Signage Configuration
# Generated on Sat Aug 10 12:00:00 UTC 2024
DEVICE_ID="pi-1234567890abcdef"
SCREEN_ID="d732c7ac-076d-471c-b656-f40f8d1857e5"
DEVICE_TOKEN="pi_abc123def456..."
API_URL="https://mesophy.vercel.app/api/screens/d732c7ac-076d-471c-b656-f40f8d1857e5/current-content"
API_BASE_URL="https://mesophy.vercel.app"
LAST_UPDATED="2024-08-10T12:00:00Z"
```

## API Reference

### Device Lookup Endpoint

**Endpoint**: `GET /api/devices/lookup?device_id={device_id}`

**Parameters**:
- `device_id` (required): Unique device identifier

**Response - Paired Device**:
```json
{
  "paired": true,
  "device": {
    "device_id": "pi-1234567890abcdef",
    "screen_id": "d732c7ac-076d-471c-b656-f40f8d1857e5",
    "screen_name": "Main Display",
    "screen_type": "promo_board",
    "device_token": "pi_abc123def456...",
    "resolution": "1920x1080",
    "orientation": "landscape",
    "is_active": true,
    "location": {
      "id": "loc-123",
      "name": "Store #001",
      "timezone": "America/New_York"
    },
    "content_url": "/api/screens/d732c7ac-076d-471c-b656-f40f8d1857e5/current-content",
    "sync_url": "/api/devices/sync?device_token=pi_abc123def456...",
    "heartbeat_url": "/api/devices/pi-1234567890abcdef/heartbeat"
  }
}
```

**Response - Unpaired Device**:
```json
{
  "paired": false,
  "message": "Device not found in system. Please pair this device through the admin portal.",
  "device_id": "pi-1234567890abcdef"
}
```

## Troubleshooting

### Common Issues

#### 1. Device ID Generation Fails
```bash
# Check if device ID script exists and is executable
ls -la /opt/mesophy/bin/pi-device-id.sh

# Test device ID generation manually
/opt/mesophy/bin/pi-device-id.sh info

# Check system identifiers
cat /proc/cpuinfo | grep Serial
ip link show
```

#### 2. API Connection Fails
```bash
# Test internet connectivity
ping -c 3 mesophy.vercel.app

# Test API endpoint
curl -v "https://mesophy.vercel.app/api/devices/lookup?device_id=test"

# Check DNS resolution
nslookup mesophy.vercel.app
```

#### 3. Pairing Not Detected
```bash
# Check device ID matches portal
mesophy-device-id

# Test pairing API directly
curl "https://mesophy.vercel.app/api/devices/lookup?device_id=$(mesophy-device-id)"

# Check device configuration
cat /opt/mesophy/config/signage.conf
```

#### 4. Display Issues
```bash
# Check framebuffer permissions
sudo ls -la /dev/fb0

# Test FBI directly
sudo fbi -T 1 -a /path/to/test-image.png

# Check display configuration
cat /boot/config.txt | grep hdmi
```

### Log Files

- **Signage logs**: `/tmp/pi-signage.log`
- **System logs**: `journalctl -u mesophy-signage`
- **Device ID logs**: `/opt/mesophy/logs/enhanced-display.log`

### Reset Device

To completely reset a device:

```bash
# Stop services
sudo systemctl stop mesophy-signage
mesophy-signage stop

# Remove configuration
sudo rm -rf /opt/mesophy/config/*
rm -rf /tmp/pi-signage/*

# Generate new device ID
mesophy-device-id generate

# Restart
mesophy-signage start
```

## Development

### Testing

Run the comprehensive test suite:

```bash
./test-pairing-system.sh
```

Individual test components:
```bash
./test-pairing-system.sh device-id
./test-pairing-system.sh api
./test-pairing-system.sh lookup
./test-pairing-system.sh instructions
```

### File Structure

```
/opt/mesophy/
├── bin/
│   ├── pi-signage.sh              # Main signage script
│   ├── pi-device-id.sh            # Device identification
│   └── show-pairing-instructions.sh # Pairing display
├── config/
│   ├── device-id.conf             # Device configuration
│   └── signage.conf               # Signage configuration
├── logs/
│   └── enhanced-display.log       # Application logs
└── temp/
    ├── pairing-instructions.png    # Generated pairing image
    └── *.json                     # API response cache
```

### Environment Variables

The system uses these environment variables:

- `DEVICE_ID`: Unique device identifier
- `SCREEN_ID`: Assigned screen ID from portal
- `API_URL`: Content API endpoint
- `API_BASE_URL`: Base API URL
- `DEVICE_TOKEN`: Authentication token

## Security Considerations

1. **Device Tokens**: Stored securely in config files with restricted permissions
2. **API Communication**: Uses HTTPS for all API calls
3. **File Permissions**: Configuration files readable only by pi user
4. **No Hardcoded Credentials**: All authentication is token-based

## Migration from Legacy System

For Pi devices using the old hardcoded screen ID system:

1. **Backup current configuration**:
   ```bash
   cp pi-signage.sh pi-signage.sh.backup
   ```

2. **Install new system**:
   ```bash
   sudo ./install-pairing-system.sh
   ```

3. **Get device ID and pair in portal**:
   ```bash
   mesophy-device-id
   # Use this ID in admin portal
   ```

4. **Start new system**:
   ```bash
   sudo systemctl start mesophy-signage
   ```

The new system is fully backward compatible and will migrate existing devices automatically.

## Support

For issues or questions:

1. Check logs: `mesophy-signage logs`
2. Run diagnostics: `./test-pairing-system.sh`
3. View status: `mesophy-signage status`
4. Contact support with device ID and log files

---

**Version**: 1.0.0  
**Last Updated**: August 10, 2024  
**Compatibility**: Raspberry Pi OS (Debian-based)